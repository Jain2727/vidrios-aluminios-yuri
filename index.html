<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Vidrios y Aluminios Yuri - Cotizador Profesional</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body{
    font-family:'Inter',sans-serif;
    background:#f4f7fb;
    margin:25px;
    color:#003366;
}
h1{font-size:28px;font-weight:700;}
.panel{
    background:white;
    padding:20px;
    border-radius:15px;
    box-shadow:0 8px 25px rgba(0,0,0,0.08);
    margin-bottom:30px;
}
input,textarea{
    width:100%;
    padding:8px;
    border-radius:8px;
    border:1px solid #0073e6;
    margin-top:5px;
}
button{
    background:#0059b3;
    color:white;
    border:none;
    padding:8px 14px;
    border-radius:8px;
    cursor:pointer;
    margin:5px 3px;
}
button:hover{background:#004494;}
button.danger{background:#cc0000;}
.flex{display:flex;gap:10px;flex-wrap:wrap;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th{background:#0059b3;color:white;padding:8px;}
td{border:1px solid #ccc;padding:6px;}
.total-box{
    background:#eef5ff;
    padding:12px;
    border-radius:10px;
    margin-top:10px;
    text-align:right;
    font-weight:600;
}
#preview{
    width:100%;
    height:650px;
    border:1px solid #ccc;
    margin-top:20px;
}
.remove-btn{
    position:absolute;
    top:-5px;
    right:-5px;
    background:red;
    color:white;
    border-radius:50%;
    width:20px;
    height:20px;
    border:none;
    cursor:pointer;
}
#pdfContent{
    font-family:'Times New Roman',serif;
    width:800px;
    padding:30px;
}
</style>
</head>

<body>

<h1>VIDRIOS Y ALUMINIOS YURI</h1>

<!-- CONFIGURACIN -->
<div class="panel">
<h3>Configuraci贸n Empresa</h3>

<label>Logo PNG</label>
<input type="file" id="logoInput" accept="image/png">
<div style="position:relative;display:inline-block;">
<img id="logoPreview" style="max-height:80px;">
<button class="remove-btn" onclick="eliminarLogo()"></button>
</div>

<label>Firma PNG</label>
<input type="file" id="firmaInput" accept="image/png">
<div style="position:relative;display:inline-block;">
<img id="firmaPreview" style="max-height:80px;">
<button class="remove-btn" onclick="eliminarFirma()"></button>
</div>

</div>

<!-- HISTORIAL -->
<div class="panel">
<h3>Historial</h3>
<input type="text" id="buscar" placeholder="Buscar cliente / DNI">
<button onclick="mostrarHistorial()">Buscar</button>

<table>
<thead>
<tr>
<th>N掳</th>
<th>Cliente</th>
<th>DNI</th>
<th>Total</th>
<th>Acci贸n</th>
</tr>
</thead>
<tbody id="historial"></tbody>
</table>
<button onclick="nueva()">Nueva</button>
</div>

<!-- FORMULARIO -->
<div class="panel" id="formulario" style="display:none;">
<h3>Cotizaci贸n</h3>

<label>Cliente</label>
<input id="cliente">

<label>DNI / RUC</label>
<input id="doc">

<label>Tel茅fono</label>
<input id="telefono">

<label>Direcci贸n</label>
<textarea id="direccion"></textarea>

<h4>Items</h4>
<input id="descripcion" placeholder="Descripci贸n">
<input id="cantidad" type="number" value="1">
<input id="precio" type="number" value="0">
<button onclick="agregar()">Agregar</button>

<table>
<thead>
<tr>
<th>#</th>
<th>Descripci贸n</th>
<th>Cant</th>
<th>Precio</th>
<th>Subtotal</th>
</tr>
</thead>
<tbody id="items"></tbody>
</table>

<div class="total-box">
Subtotal: S/ <span id="sub">0.00</span><br>
IGV: S/ <span id="igv">0.00</span><br>
TOTAL: S/ <span id="tot">0.00</span>
</div>

<button onclick="vista()">Vista PDF</button>
<button onclick="pdf()">Descargar PDF</button>

<iframe id="preview"></iframe>
</div>

<div id="pdfContent" style="display:none;"></div>

<script>
let lista=[];

// LOGO Y FIRMA
logoInput.onchange=e=>{
    const reader=new FileReader();
    reader.onload=ev=>logoPreview.src=ev.target.result;
    reader.readAsDataURL(e.target.files[0]);
};
firmaInput.onchange=e=>{
    const reader=new FileReader();
    reader.onload=ev=>firmaPreview.src=ev.target.result;
    reader.readAsDataURL(e.target.files[0]);
};
function eliminarLogo(){logoPreview.src="";}
function eliminarFirma(){firmaPreview.src="";}

// NUEVA
function nueva(){
document.getElementById("formulario").style.display="block";
lista=[];
render();
vista(); //  Vista previa autom谩tica sin datos
}

// AGREGAR ITEM
function agregar(){
const d=descripcion.value;
const c=parseFloat(cantidad.value);
const p=parseFloat(precio.value);
if(!d)return;
lista.push({d,c,p});
render();
vista();
}

// RENDER
function render(){
let html="";
let sub=0;
lista.forEach((i,idx)=>{
let st=i.c*i.p;
sub+=st;
html+=`<tr>
<td>${idx+1}</td>
<td>${i.d}</td>
<td>${i.c}</td>
<td>${i.p.toFixed(2)}</td>
<td>${st.toFixed(2)}</td>
</tr>`;
});
items.innerHTML=html;
sub=sub||0;
let igv=sub*0.18;
let total=sub+igv;
document.getElementById("sub").innerText=sub.toFixed(2);
document.getElementById("igv").innerText=igv.toFixed(2);
document.getElementById("tot").innerText=total.toFixed(2);
}

// BUSCAR
function mostrarHistorial(){
let data=JSON.parse(localStorage.getItem("cotizaciones"))||[];
let b=buscar.value.toLowerCase();
let filtrado=data.filter(c=>c.cliente.toLowerCase().includes(b));
if(filtrado.length===0){
historial.innerHTML=`<tr><td colspan="5" style="text-align:center;color:red;">No se encuentra</td></tr>`;
return;
}
let html="";
filtrado.forEach(c=>{
html+=`<tr>
<td>${c.numero}</td>
<td>${c.cliente}</td>
<td>${c.doc}</td>
<td>${c.total}</td>
<td>-</td>
</tr>`;
});
historial.innerHTML=html;
}

// VISTA PDF
async function vista(){
const cot={
cliente:cliente.value||"",
doc:doc.value||"",
telefono:telefono.value||"",
direccion:direccion.value||"",
items:lista
};
pdfContent.innerHTML=crearPDF(cot);
pdfContent.style.display="block";
await new Promise(r=>setTimeout(r,200));
const canvas=await html2canvas(pdfContent,{scale:2});
const imgData=canvas.toDataURL("image/png");
const docPDF=new jspdf.jsPDF("p","pt","a4");
const width=docPDF.internal.pageSize.getWidth();
const height=(canvas.height*width)/canvas.width;
docPDF.addImage(imgData,"PNG",0,0,width,height);
preview.src=docPDF.output("bloburl");
pdfContent.style.display="none";
}

// DESCARGAR
async function pdf(){
await vista();
const docPDF=new jspdf.jsPDF("p","pt","a4");
const canvas=await html2canvas(pdfContent,{scale:3});
const imgData=canvas.toDataURL("image/png");
const width=docPDF.internal.pageSize.getWidth();
const height=(canvas.height*width)/canvas.width;
docPDF.addImage(imgData,"PNG",0,0,width,height);
docPDF.save("Cotizacion.pdf");
}

// CREAR DISEO BONITO
function crearPDF(cot){
let filas="";
let sub=0;
cot.items.forEach((i,idx)=>{
let st=i.c*i.p;
sub+=st;
filas+=`<tr>
<td>${idx+1}</td>
<td style="text-align:justify;">${i.d}</td>
<td>${i.c}</td>
<td>${i.p.toFixed(2)}</td>
<td>${st.toFixed(2)}</td>
</tr>`;
});
let igv=sub*0.18;
let total=sub+igv;

return `
<div style="font-size:13px;">
<div style="display:flex;justify-content:space-between;">
<div>
<h2 style="margin:0;">VIDRIOS Y ALUMINIOS YURI</h2>
RUC: 10617365036<br>
Direcci贸n: APLAS JOYAS, SAN SEBASTIN - CUSCO
</div>
<div>${logoPreview.src?`<img src="${logoPreview.src}" style="max-height:80px;">`:""}</div>
</div>

<hr>

<b>Cliente:</b> ${cot.cliente}<br>
<b>DNI/RUC:</b> ${cot.doc}<br>
<b>Tel茅fono:</b> ${cot.telefono}<br>
<b>Direcci贸n:</b> ${cot.direccion}

<table border="1" width="100%" style="margin-top:15px;border-collapse:collapse;">
<tr style="background:#0059b3;color:white;">
<th>#</th>
<th>Descripci贸n</th>
<th>Cant</th>
<th>P.Unit</th>
<th>Subtotal</th>
</tr>
${filas}
</table>

<br>
<div style="text-align:right;">
Costo: S/ ${sub.toFixed(2)}<br>
IGV (18%): S/ ${igv.toFixed(2)}<br>
<b style="font-size:15px;">TOTAL: S/ ${total.toFixed(2)}</b>
</div>

<br><br>
M茅todo de pago:<br>
Cuenta BCP: 52671107164027<br>
CCI: 00 2526 1711 0716 4027 21

<br><br><br>
<div style="display:flex;justify-content:space-between;">
<div>
${firmaPreview.src?`<img src="${firmaPreview.src}" style="max-height:70px;">`:""}
<br>_________________________<br>
Firma
</div>
<div>
Fecha: ${new Date().toLocaleDateString()}
</div>
</div>
</div>
`;
}
</script>

</body>
</html>
