<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cotizaciones - Vidrios y Aluminios Yuri</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Inter:wght@400;600&display=swap');

body{
  font-family: 'Inter', sans-serif;
  background:#f4f7fc;
  margin:20px;
  color:#003366;
}

h1{
  font-family:'Merriweather', serif;
  font-size:28px;
  border-bottom:3px solid #0059b3;
  padding-bottom:8px;
}

.panel{
  background:white;
  padding:25px;
  border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
  margin-bottom:40px;
}

label{font-weight:600;}

input,textarea{
  width:100%;
  padding:8px;
  margin-bottom:12px;
  border-radius:6px;
  border:1.5px solid #0073e6;
}

button{
  padding:8px 15px;
  border:none;
  border-radius:6px;
  background:#0059b3;
  color:white;
  cursor:pointer;
  margin-right:8px;
}

button.danger{background:#cc0000;}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}

th{
  background:#0059b3;
  color:white;
  padding:10px;
}

td{
  padding:8px;
  border:1px solid #d0d7e2;
}

.flex{
  display:flex;
  gap:15px;
}
.flex>div{flex:1;}
</style>
</head>

<body>

<h1>VIDRIOS Y ALUMINIOS YURI</h1>

<div class="panel" id="dashboard">
<h2>Historial</h2>
<table>
<thead>
<tr>
<th>N°</th>
<th>Cliente</th>
<th>Fecha</th>
<th>Total</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="historial"></tbody>
</table>
<br>
<button onclick="nueva()">+ Nueva Cotización</button>
</div>

<div class="panel" id="formulario" style="display:none;">

<h2>Crear Cotización</h2>

<div class="flex">
<div>
<label>N° Cotización</label>
<input id="numero">
</div>
<div>
<label>Fecha Emisión</label>
<input type="date" id="fecha">
</div>
<div>
<label>Válida hasta</label>
<input type="date" id="validez">
</div>
</div>

<h3>Cliente</h3>

<input id="nombre" placeholder="Nombre">
<input id="doc" placeholder="DNI / RUC">
<input id="telefono" placeholder="Teléfono">
<textarea id="direccion" placeholder="Dirección"></textarea>

<h3>Servicios</h3>

<div class="flex">
<input id="desc" placeholder="Descripción">
<input id="cant" type="number" value="1">
<input id="precio" type="number" value="0">
</div>

<button onclick="agregar()">Agregar Ítem</button>

<table>
<thead>
<tr>
<th>#</th>
<th>Descripción</th>
<th>Cant</th>
<th>P.Unit</th>
<th>Subtotal</th>
<th></th>
</tr>
</thead>
<tbody id="items"></tbody>
</table>

<br>
<div style="text-align:right;font-weight:600;">
Subtotal: S/ <span id="sub">0.00</span><br>
IGV 18%: S/ <span id="igv">0.00</span><br>
Total: S/ <span id="total">0.00</span>
</div>

<br>
<button onclick="guardar()">Guardar</button>
<button onclick="pdf()">Descargar PDF</button>
<button onclick="cancelar()" class="danger">Cancelar</button>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>

let cotizaciones = JSON.parse(localStorage.getItem("cotizaciones")) || [];
let items = [];
let editando = null;

function siguienteNumeroLibre(){
  let usados = cotizaciones.map(c=>parseInt(c.numero));
  let n=1;
  while(usados.includes(n)) n++;
  return n;
}

function nueva(){
  document.getElementById("dashboard").style.display="none";
  document.getElementById("formulario").style.display="block";
  editando=null;
  items=[];
  renderItems();
  actualizarTotales();
  document.getElementById("numero").value = siguienteNumeroLibre();
  let hoy = new Date().toISOString().split("T")[0];
  document.getElementById("fecha").value = hoy;
  let v=new Date();v.setDate(v.getDate()+7);
  document.getElementById("validez").value=v.toISOString().split("T")[0];
}

function cancelar(){
  document.getElementById("dashboard").style.display="block";
  document.getElementById("formulario").style.display="none";
}

function agregar(){
  let d=document.getElementById("desc").value;
  let c=parseFloat(document.getElementById("cant").value);
  let p=parseFloat(document.getElementById("precio").value);
  if(!d)return;
  items.push({d,c,p,sub:c*p});
  renderItems();
  actualizarTotales();
}

function renderItems(){
  let tbody=document.getElementById("items");
  tbody.innerHTML="";
  items.forEach((it,i)=>{
    tbody.innerHTML+=`
    <tr>
      <td>${i+1}</td>
      <td>${it.d}</td>
      <td>${it.c}</td>
      <td>${it.p.toFixed(2)}</td>
      <td>${it.sub.toFixed(2)}</td>
      <td><button onclick="eliminarItem(${i})">X</button></td>
    </tr>`;
  });
}

function eliminarItem(i){
  items.splice(i,1);
  renderItems();
  actualizarTotales();
}

function actualizarTotales(){
  let sub=items.reduce((a,b)=>a+b.sub,0);
  let igv=sub*0.18;
  let total=sub+igv;
  document.getElementById("sub").innerText=sub.toFixed(2);
  document.getElementById("igv").innerText=igv.toFixed(2);
  document.getElementById("total").innerText=total.toFixed(2);
}

function guardar(){
  let cot={
    id:editando||Date.now(),
    numero:parseInt(document.getElementById("numero").value),
    fecha:document.getElementById("fecha").value,
    validez:document.getElementById("validez").value,
    nombre:document.getElementById("nombre").value,
    total:parseFloat(document.getElementById("total").innerText),
    items:items
  };
  if(editando){
    cotizaciones=cotizaciones.map(c=>c.id==editando?cot:c);
  }else{
    cotizaciones.push(cot);
  }
  localStorage.setItem("cotizaciones",JSON.stringify(cotizaciones));
  cancelar();
  cargar();
}

function eliminar(id){
  cotizaciones=cotizaciones.filter(c=>c.id!=id);
  localStorage.setItem("cotizaciones",JSON.stringify(cotizaciones));
  cargar();
}

function cargar(){
  let h=document.getElementById("historial");
  h.innerHTML="";
  cotizaciones.sort((a,b)=>a.numero-b.numero);
  cotizaciones.forEach(c=>{
    h.innerHTML+=`
    <tr>
      <td>${c.numero}</td>
      <td>${c.nombre}</td>
      <td>${c.fecha}</td>
      <td>S/ ${c.total.toFixed(2)}</td>
      <td><button onclick="eliminar(${c.id})">Eliminar</button></td>
    </tr>`;
  });
}
cargar();

async function pdf(){
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF();

  let numero=document.getElementById("numero").value;
  let fecha=document.getElementById("fecha").value;
  let validez=document.getElementById("validez").value;

  let sub=parseFloat(document.getElementById("sub").innerText);
  let igv=sub*0.18;
  let total=sub+igv;

  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.text("VIDRIOS Y ALUMINIOS YURI",20,20);

  doc.setFontSize(12);
  doc.text("COTIZACIÓN N° "+numero,150,20);

  doc.setFontSize(10);
  doc.text("Fecha: "+fecha,150,28);
  doc.text("Válida hasta: "+validez,150,34);

  doc.setFontSize(12);
  doc.text("Cliente: "+document.getElementById("nombre").value,20,40);

  // Marca de agua
  doc.setTextColor(230);
  doc.setFontSize(60);
  doc.text("YURI",60,150,{angle:45});
  doc.setTextColor(0);

  let y=60;
  doc.setFontSize(10);
  items.forEach((it,i)=>{
    doc.text(`${i+1}. ${it.d} | Cant:${it.c} | P:${it.p} | Sub:${it.sub}`,20,y);
    y+=8;
  });

  y+=10;
  doc.setFont("helvetica","bold");
  doc.text("Subtotal: S/ "+sub.toFixed(2),140,y);
  y+=8;
  doc.text("IGV: S/ "+igv.toFixed(2),140,y);
  y+=8;
  doc.text("TOTAL: S/ "+total.toFixed(2),140,y);

  doc.save("Cotizacion_"+numero+".pdf");
}

</script>
</body>
</html>
