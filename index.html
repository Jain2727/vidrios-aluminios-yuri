<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vidrios y Aluminios Yuri - Sistema Profesional</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body{
  font-family:'Inter',sans-serif;
  background:#f4f7fb;
  margin:20px;
  color:#003366;
}
h1{font-size:28px;margin-bottom:20px;}
.panel{
  background:#fff;
  padding:20px;
  border-radius:14px;
  box-shadow:0 6px 20px rgba(0,0,0,.08);
  margin-bottom:30px;
}
input,textarea,select{
  width:100%;
  padding:8px;
  margin-top:5px;
  margin-bottom:10px;
  border-radius:8px;
  border:1px solid #0073e6;
}
button{
  background:#0059b3;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
  margin:4px;
}
button:hover{background:#003f88;}
button.danger{background:#c40000;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ddd;padding:8px;font-size:14px;}
th{background:#0059b3;color:#fff;}
.total-box{
  background:#eef5ff;
  padding:15px;
  border-radius:12px;
  margin-top:15px;
  font-weight:600;
}
#preview{
  width:100%;
  height:600px;
  border:1px solid #ccc;
  margin-top:15px;
}
</style>
</head>
<body>

<h1>VIDRIOS Y ALUMINIOS YURI - SISTEMA PROFESIONAL</h1>

<div class="panel">
<h2>Historial</h2>
<input type="text" id="buscar" placeholder="Buscar cliente...">
<button onclick="mostrarHistorial()">Buscar</button>
<button onclick="nueva()">+ Nueva</button>
<table>
<thead>
<tr>
<th>N°</th>
<th>Cliente</th>
<th>Fecha</th>
<th>Estado</th>
<th>Total</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="historial"></tbody>
</table>
</div>

<div class="panel" id="formulario" style="display:none;">
<h2>Cotización</h2>

<label>N°</label>
<input id="numero" readonly>

<label>Fecha</label>
<input type="date" id="fecha">

<label>Cliente</label>
<input id="cliente">

<label>DNI / RUC</label>
<input id="doc">

<label>Teléfono</label>
<input id="telefono">

<label>Dirección</label>
<textarea id="direccion"></textarea>

<label>Estado</label>
<select id="estado">
<option>Pendiente</option>
<option>Aprobada</option>
<option>Rechazada</option>
</select>

<h3>Items</h3>

<input id="descripcion" placeholder="Descripción">
<input id="cantidad" type="number" value="1">
<input id="precio" type="number" value="0">
<button onclick="agregar()">Agregar</button>

<table>
<thead>
<tr>
<th>#</th>
<th>Descripción</th>
<th>Cant</th>
<th>Precio</th>
<th>Subtotal</th>
<th></th>
</tr>
</thead>
<tbody id="items"></tbody>
</table>

<label>Descuento (%)</label>
<input type="number" id="descuento" value="0" oninput="render()">

<label>Condiciones de Pago</label>
<textarea id="condiciones">50% adelanto y 50% contra entrega</textarea>

<label>Observaciones</label>
<textarea id="observaciones"></textarea>

<div class="total-box">
Subtotal: S/ <span id="sub">0.00</span><br>
Descuento: S/ <span id="descMonto">0.00</span><br>
IGV (18%): S/ <span id="igv">0.00</span><br>
TOTAL: S/ <span id="tot">0.00</span>
</div>

<button onclick="guardar()">Guardar</button>
<button onclick="vista()">Vista PDF</button>
<button onclick="pdf()">Descargar PDF</button>
<button onclick="duplicar()">Duplicar</button>
<button onclick="cancelar()" class="danger">Cancelar</button>

<iframe id="preview"></iframe>
</div>

<div id="pdfContent" style="display:none;"></div>

<script>

let lista=[];

function generarNumero(){
  const año=new Date().getFullYear();
  let data=JSON.parse(localStorage.getItem("cotizaciones"))||[];
  let num=data.length+1;
  return año+"-"+num.toString().padStart(4,"0");
}

function nueva(){
  lista=[];
  document.getElementById("formulario").style.display="block";
  document.getElementById("numero").value=generarNumero();
  document.getElementById("fecha").value=new Date().toISOString().split("T")[0];
  render();
}

function agregar(){
  const desc=document.getElementById("descripcion").value;
  const cant=parseFloat(document.getElementById("cantidad").value);
  const pre=parseFloat(document.getElementById("precio").value);
  if(!desc||cant<=0||pre<0)return alert("Datos inválidos");
  lista.push({desc,cant,pre});
  document.getElementById("descripcion").value="";
  render();
}

function render(){
  let tbody=document.getElementById("items");
  tbody.innerHTML="";
  let subtotal=0;
  lista.forEach((i,index)=>{
    let st=i.cant*i.pre;
    subtotal+=st;
    tbody.innerHTML+=`
    <tr>
    <td>${index+1}</td>
    <td>${i.desc}</td>
    <td>${i.cant}</td>
    <td>${i.pre.toFixed(2)}</td>
    <td>${st.toFixed(2)}</td>
    <td><button onclick="eliminarItem(${index})">X</button></td>
    </tr>`;
  });

  let descP=parseFloat(document.getElementById("descuento").value)||0;
  let descMonto=subtotal*(descP/100);
  let base=subtotal-descMonto;
  let igv=base*0.18;
  let total=base+igv;

  document.getElementById("sub").textContent=subtotal.toFixed(2);
  document.getElementById("descMonto").textContent=descMonto.toFixed(2);
  document.getElementById("igv").textContent=igv.toFixed(2);
  document.getElementById("tot").textContent=total.toFixed(2);
}

function eliminarItem(i){
  lista.splice(i,1);
  render();
}

function guardar(){
  let data=JSON.parse(localStorage.getItem("cotizaciones"))||[];
  let cot={
    numero:numero.value,
    fecha:fecha.value,
    cliente:cliente.value,
    estado:estado.value,
    total:tot.textContent
  };
  data.push(cot);
  localStorage.setItem("cotizaciones",JSON.stringify(data));
  alert("Guardado");
  cancelar();
  mostrarHistorial();
}

function mostrarHistorial(){
  let data=JSON.parse(localStorage.getItem("cotizaciones"))||[];
  let html="";
  data.forEach(c=>{
    html+=`<tr>
    <td>${c.numero}</td>
    <td>${c.cliente}</td>
    <td>${c.fecha}</td>
    <td>${c.estado}</td>
    <td>${c.total}</td>
    <td><button onclick="eliminar('${c.numero}')">Eliminar</button></td>
    </tr>`;
  });
  historial.innerHTML=html;
}

function eliminar(num){
  let data=JSON.parse(localStorage.getItem("cotizaciones"))||[];
  data=data.filter(c=>c.numero!==num);
  localStorage.setItem("cotizaciones",JSON.stringify(data));
  mostrarHistorial();
}

function cancelar(){
  document.getElementById("formulario").style.display="none";
}

function duplicar(){
  nueva();
}

async function vista(){
  pdf();
}

async function pdf(){
  const pdfDiv=document.getElementById("pdfContent");
  pdfDiv.innerHTML=`<h1 style="text-align:center;">VIDRIOS Y ALUMINIOS YURI</h1>
  <h2>${numero.value}</h2>
  <p><b>Cliente:</b> ${cliente.value}</p>
  <p><b>Fecha:</b> ${fecha.value}</p>
  <hr>
  <p>Total: S/ ${tot.textContent}</p>
  <br><p style="opacity:0.1;font-size:60px;text-align:center;">VIDRIOS Y ALUMINIOS YURI</p>`;

  pdfDiv.style.display="block";

  const canvas=await html2canvas(pdfDiv,{scale:3});
  const imgData=canvas.toDataURL("image/png");
  const doc=new jspdf.jsPDF();
  doc.addImage(imgData,"PNG",0,0,210,297);
  doc.save("Cotizacion.pdf");

  pdfDiv.style.display="none";
}

mostrarHistorial();

</script>
</body>
</html>
