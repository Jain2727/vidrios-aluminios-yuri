<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vidrios y Aluminios Yuri - Sistema Profesional</title>

<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body{
  font-family:'Inter',sans-serif;
  background:#f2f5fa;
  margin:25px;
  color:#003366;
}
h1{
  font-family:'Merriweather',serif;
  font-size:30px;
  border-bottom:3px solid #0059b3;
  padding-bottom:10px;
  margin-bottom:20px;
}
.panel{
  background:white;
  padding:25px;
  border-radius:15px;
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
  margin-bottom:40px;
}
input,textarea{
  width:100%;
  padding:8px;
  margin-bottom:10px;
  border-radius:8px;
  border:1.5px solid #0073e6;
  box-sizing:border-box;
}
button{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  background:#0059b3;
  color:white;
  cursor:pointer;
  margin-right:6px;
  margin-top:5px;
  transition: 0.2s;
}
button:hover{opacity:0.85;}
button.danger{background:#cc0000;}
button.gray{background:#6c757d;}
.flex{display:flex;gap:10px;flex-wrap:wrap;}
.flex>div{flex:1;}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th{
  background:#0059b3;
  color:white;
  padding:8px;
  text-align:center;
}
td{
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
}
td.left{text-align:left;}
.total-box{
  background:#eef5ff;
  padding:15px;
  border-radius:10px;
  text-align:right;
  font-weight:600;
}
.logo-preview,.firma-preview{max-height:80px;margin-top:10px;display:block;}
#logoPreviewWrapper,#firmaPreviewWrapper{position:relative;}
.remove-btn{
  position:absolute;
  top:-10px;
  right:-10px;
  background:red;
  color:white;
  border-radius:50%;
  border:none;
  width:22px;
  height:22px;
  font-size:14px;
  cursor:pointer;
}
#preview{width:100%;height:600px;border:1px solid #ccc;margin-top:20px;}
</style>
</head>

<body>

<h1>VIDRIOS Y ALUMINIOS YURI</h1>

<!-- CONFIGURACIÓN EMPRESA -->
<div class="panel">
<h3>Configuración Empresa</h3>

<label>Subir Logo PNG</label>
<input type="file" id="logoInput" accept="image/png">
<div id="logoPreviewWrapper">
  <img id="logoPreview" class="logo-preview">
  <button class="remove-btn" id="removeLogoBtn" style="display:none;">&times;</button>
</div>

<label>Subir Firma PNG</label>
<input type="file" id="firmaInput" accept="image/png">
<div id="firmaPreviewWrapper">
  <img id="firmaPreview" class="firma-preview">
  <button class="remove-btn" id="removeFirmaBtn" style="display:none;">&times;</button>
</div>
</div>

<!-- HISTORIAL -->
<div class="panel">
<h2>Historial de Cotizaciones</h2>
<div class="flex">
<input type="text" id="buscar" placeholder="Buscar por cliente / DNI / RUC">
<button onclick="mostrarHistorial()">Buscar</button>
</div>
<table>
<thead>
<tr>
<th>N°</th>
<th>Cliente</th>
<th>DNI/RUC</th>
<th>Fecha</th>
<th>Total</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="historial"></tbody>
</table>
<br>
<button onclick="nueva()">+ Nueva Cotización</button>
</div>

<!-- FORMULARIO COTIZACIÓN -->
<div class="panel" id="formulario" style="display:none;">

<h2>Cotización</h2>

<div class="flex">
<div><label>N°</label><input id="numero" readonly></div>
<div><label>Fecha Emisión</label><input type="date" id="fecha"></div>
<div><label>Validez</label><input type="date" id="validez"></div>
</div>

<h3>Cliente</h3>
<input id="cliente" placeholder="Nombre">
<input id="doc" placeholder="DNI / RUC">
<input id="telefono" placeholder="Teléfono">
<textarea id="direccion" placeholder="Dirección"></textarea>

<h3>Ítems</h3>
<div class="flex">
<input id="codigo" placeholder="Código">
<input id="descripcion" placeholder="Descripción">
<input id="medidas" placeholder="Medidas">
<input id="cantidad" type="number" value="1" min="1">
<input id="precio" type="number" value="0" min="0" step="0.01">
</div>
<button onclick="agregar()">Agregar Item</button>

<table>
<thead>
<tr>
<th>Item</th><th>Código</th><th>Descripción</th><th>Medidas</th>
<th>Cantidad</th><th>Precio Unitario</th><th>Subtotal</th><th>Acción</th>
</tr>
</thead>
<tbody id="items"></tbody>
</table>

<div class="total-box">
Subtotal: S/ <span id="sub">0.00</span><br>
IGV 18%: S/ <span id="igv">0.00</span><br>
TOTAL: S/ <span id="tot">0.00</span>
</div>

<br>
<button onclick="guardar()">Guardar</button>
<button onclick="vista()">Vista PDF</button>
<button onclick="pdf()">Descargar PDF</button>
<button onclick="imagen()">Exportar Imagen</button>
<button onclick="whatsapp()">WhatsApp</button>
<button onclick="cancelar()" class="danger">Cancelar</button>

<iframe id="preview"></iframe>

</div>

<script>
let lista=[];
let editIndex=null;

// LOGO / FIRMA
const logoInput=document.getElementById("logoInput");
const firmaInput=document.getElementById("firmaInput");
const logoPreview=document.getElementById("logoPreview");
const firmaPreview=document.getElementById("firmaPreview");
const removeLogoBtn=document.getElementById("removeLogoBtn");
const removeFirmaBtn=document.getElementById("removeFirmaBtn");

logoInput.addEventListener("change",e=>{
  if(e.target.files && e.target.files[0]){
    const reader=new FileReader();
    reader.onload=e=>{logoPreview.src=e.target.result; removeLogoBtn.style.display="inline-block";}
    reader.readAsDataURL(e.target.files[0]);
  }
});
firmaInput.addEventListener("change",e=>{
  if(e.target.files && e.target.files[0]){
    const reader=new FileReader();
    reader.onload=e=>{firmaPreview.src=e.target.result; removeFirmaBtn.style.display="inline-block";}
    reader.readAsDataURL(e.target.files[0]);
  }
});
removeLogoBtn.onclick=()=>{logoPreview.src=""; removeLogoBtn.style.display="none";}
removeFirmaBtn.onclick=()=>{firmaPreview.src=""; removeFirmaBtn.style.display="none";}

// HISTORIAL
function mostrarHistorial(){
  let data=JSON.parse(localStorage.getItem("cotizaciones"))||[];
  let buscar=document.getElementById("buscar").value.toLowerCase();
  let html="";
  let filtrado=data.filter(c=>c.cliente.toLowerCase().includes(buscar)||c.doc.includes(buscar));
  if(filtrado.length===0){
    html=`<tr><td colspan="6" style="text-align:center;">No hay cotizaciones.</td></tr>`;
  }else{
    filtrado.sort((a,b)=>a.numero-b.numero);
    filtrado.forEach((c,i)=>{
      html+=`<tr>
      <td>${c.numero}</td>
      <td class="left">${c.cliente}</td>
      <td>${c.doc}</td>
      <td>${c.fecha}</td>
      <td>${c.total}</td>
      <td>
        <button onclick="editar(${c.numero})">Editar</button>
        <button onclick="eliminar(${c.numero})" class="danger">Eliminar</button>
      </td>
      </tr>`;
    });
  }
  document.getElementById("historial").innerHTML=html;
}

// BUSCAR EN TIEMPO REAL CON BOTÓN
document.getElementById("buscar").addEventListener("keypress",e=>{if(e.key==='Enter') mostrarHistorial();});

// NUEVA COTIZACIÓN
function nueva(){
  document.getElementById("formulario").style.display="block";
  lista=[];
  render();
  generarNumero();
  let hoy=new Date().toISOString().split('T')[0];
  document.getElementById("fecha").value=hoy;
  let val=new Date();
  val.setDate(val.getDate()+7);
  document.getElementById("validez").value=val.toISOString().split('T')[0];
  document.getElementById("cliente").value="";
  document.getElementById("doc").value="";
  document.getElementById("telefono").value="";
  document.getElementById("direccion").value="";
}

// NUMERACIÓN INTELIGENTE
function generarNumero(){
  let data=JSON.parse(localStorage.getItem("cotizaciones"))||[];
  let numeros=data.map(c=>parseInt(c.numero));
  let n=1;
  while(numeros.includes(n)) n++;
  document.getElementById("numero").value=n;
}

// ÍTEMS
function agregar(){
  let codigo=document.getElementById("codigo").value;
  let desc=document.getElementById("descripcion").value;
  let med=document.getElementById("medidas").value;
  let cant=parseFloat(document.getElementById("cantidad").value);
  let precio=parseFloat(document.getElementById("precio").value);
  if(!desc || cant<=0 || precio<0){alert("Revisa los campos"); return;}
  lista.push({codigo,desc,med,cant,precio,subtotal:cant*precio});
  render();
  document.getElementById("codigo").value="";
  document.getElementById("descripcion").value="";
  document.getElementById("medidas").value="";
  document.getElementById("cantidad").value=1;
  document.getElementById("precio").value=0;
}
function render(){
  let html="";
  lista.forEach((i,index)=>{
    html+=`<tr>
    <td>${index+1}</td><td>${i.codigo}</td><td class="left">${i.desc}</td>
    <td>${i.med}</td><td>${i.cant}</td><td>${i.precio.toFixed(2)}</td>
    <td>${i.subtotal.toFixed(2)}</td>
    <td><button onclick="eliminarItem(${index})" class="danger">X</button></td>
    </tr>`;
  });
  document.getElementById("items").innerHTML=html;
  calcular();
}
function eliminarItem(i){lista.splice(i,1); render();}

// CALCULO
function calcular(){
  let sub=lista.reduce((a,b)=>a+b.subtotal,0);
  let igv=sub*0.18;
  let tot=sub+igv;
  document.getElementById("sub").innerText=sub.toFixed(2);
  document.getElementById("igv").innerText=igv.toFixed(2);
  document.getElementById("tot").innerText=tot.toFixed(2);
}

// GUARDAR
function guardar(){
  if(lista.length===0){alert("Agrega al menos un item"); return;}
  let data=JSON.parse(localStorage.getItem("cotizaciones"))||[];
  let cot={
    numero:document.getElementById("numero").value,
    fecha:document.getElementById("fecha").value,
    validez:document.getElementById("validez").value,
    cliente:document.getElementById("cliente").value,
    doc:document.getElementById("doc").value,
    telefono:document.getElementById("telefono").value,
    direccion:document.getElementById("direccion").value,
    items:lista,
    total:document.getElementById("tot").innerText
  };
  let idx=data.findIndex(c=>c.numero==cot.numero);
  if(idx>=0)data[idx]=cot; else data.push(cot);
  localStorage.setItem("cotizaciones",JSON.stringify(data));
  alert("Guardado!");
  document.getElementById("formulario").style.display="none";
  mostrarHistorial();
}

// ELIMINAR
function eliminar(n){
  if(confirm("¿Eliminar cotización?")){
    let data=JSON.parse(localStorage.getItem("cotizaciones"))||[];
    data=data.filter(c=>c.numero!=n);
    localStorage.setItem("cotizaciones",JSON.stringify(data));
    mostrarHistorial();
  }
}

// EDITAR
function editar(n){
  let data=JSON.parse(localStorage.getItem("cotizaciones"))||[];
  let cot=data.find(c=>c.numero==n);
  if(!cot)return;
  document.getElementById("formulario").style.display="block";
  document.getElementById("numero").value=cot.numero;
  document.getElementById("fecha").value=cot.fecha;
  document.getElementById("validez").value=cot.validez;
  document.getElementById("cliente").value=cot.cliente;
  document.getElementById("doc").value=cot.doc;
  document.getElementById("telefono").value=cot.telefono;
  document.getElementById("direccion").value=cot.direccion;
  lista=cot.items||[];
  render();
}

// CANCELAR
function cancelar(){document.getElementById("formulario").style.display="none";}

// VISTA PDF
function vista(){pdf(true);}
function pdf(preview=false){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  let y=20;
  if(logoPreview.src)doc.addImage(logoPreview.src,'PNG',10,10,50,25);
  doc.setFontSize(16); doc.setFont("helvetica","bold");
  doc.text("VIDRIOS Y ALUMINIOS YURI",70,20);
  doc.setFontSize(10); doc.setFont("helvetica","normal");
  doc.text(`Fecha: ${document.getElementById("fecha").value}`,150,10);
  doc.text(`Validez: ${document.getElementById("validez").value}`,150,16);
  y+=10;
  doc.text(`Cliente: ${document.getElementById("cliente").value}`,10,y+20);
  doc.text(`DNI/RUC: ${document.getElementById("doc").value}`,10,y+26);
  doc.text(`Tel: ${document.getElementById("telefono").value}`,10,y+32);
  doc.text(`Dir: ${document.getElementById("direccion").value}`,10,y+38);
  y+=50;
  doc.setFillColor(0,102,204); doc.setTextColor(255,255,255);
  doc.rect(10,y-5,190,7,'F'); doc.setTextColor(0,0,0); doc.setFontSize(10);
  doc.text("Item",12,y);
  doc.text("Código",22,y);
  doc.text("Descripción",50,y);
  doc.text("Medidas",120,y);
  doc.text("Cantidad",140,y);
  doc.text("Precio Unitario",155,y);
  doc.text("Subtotal",185,y);
  y+=5;
  lista.forEach((i,idx)=>{
    y+=7;
    doc.text((idx+1).toString(),12,y);
    doc.text(i.codigo,22,y);
    doc.text(i.desc,50,y,{maxWidth:65});
    doc.text(i.med,120,y);
    doc.text(i.cant.toString(),140,y);
    doc.text(i.precio.toFixed(2),155,y);
    doc.text(i.subtotal.toFixed(2),185,y);
  });
  y+=10;
  let sub=parseFloat(document.getElementById("sub").innerText);
  let igv=parseFloat(document.getElementById("igv").innerText);
  let tot=parseFloat(document.getElementById("tot").innerText);
  doc.text(`Subtotal: S/ ${sub.toFixed(2)}`,140,y);
  doc.text(`IGV 18%: S/ ${igv.toFixed(2)}`,140,y+6);
  doc.setFont("helvetica","bold");
  doc.text(`TOTAL: S/ ${tot.toFixed(2)}`,140,y+12);
  if(firmaPreview.src)doc.addImage(firmaPreview.src,'PNG',10,y+15,50,20);
  if(preview)document.getElementById("preview").src=doc.output('datauristring'); else doc.save(`Cotizacion_${document.getElementById("cliente").value}_${document.getElementById("numero").value}.pdf`);
}

// EXPORTAR IMAGEN
function imagen(){
  html2canvas(document.getElementById("formulario")).then(canvas=>{
    canvas.toBlob(blob=>{
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`Cotizacion_${document.getElementById("cliente").value}.png`;
      a.click();
    });
  });
}

// WHATSAPP
function whatsapp(){
  const url=`https://wa.me/?text=${encodeURIComponent(`Hola ${document.getElementById("cliente").value}, te envío la cotización N° ${document.getElementById("numero").value} Total S/ ${document.getElementById("tot").innerText}`)}`;
  window.open(url,'_blank');
}

mostrarHistorial();
</script>

</body>
</html>
