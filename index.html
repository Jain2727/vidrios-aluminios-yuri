<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Vidrios y Aluminios Yuri - Sistema Profesional</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body{
    font-family:'Inter',sans-serif;
    background:#f3f6fb;
    margin:25px;
    color:#003366;
}
h1{
    text-align:center;
    font-size:32px;
    font-weight:800;
    letter-spacing:1px;
}
.panel{
    background:white;
    padding:20px;
    border-radius:15px;
    box-shadow:0 10px 30px rgba(0,0,0,0.08);
    margin-bottom:30px;
}
input,textarea{
    width:100%;
    padding:8px;
    border-radius:8px;
    border:1px solid #0073e6;
    margin-top:5px;
}
button{
    background:#0059b3;
    color:white;
    border:none;
    padding:8px 14px;
    border-radius:8px;
    cursor:pointer;
    margin:5px 3px;
}
button:hover{background:#004494;}
button.danger{background:#cc0000;}
.flex{display:flex;gap:10px;flex-wrap:wrap;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th{background:#0059b3;color:white;padding:8px;}
td{border:1px solid #ccc;padding:6px;}
.total-box{
    background:#eef5ff;
    padding:12px;
    border-radius:10px;
    margin-top:10px;
    text-align:right;
    font-weight:600;
}
#preview{
    width:100%;
    height:700px;
    border:1px solid #ccc;
    margin-top:20px;
}
#pdfContent{
    font-family:'Times New Roman',serif;
    width:794px;
    padding:40px;
    background:white;
}
</style>
</head>

<body>

<h1>VIDRIOS Y ALUMINIOS YURI</h1>

<div class="panel">
<button onclick="nueva()">Nueva Cotización</button>
<button onclick="guardar()">Guardar</button>
<button onclick="vista()">Vista PDF</button>
<button onclick="descargarPDF()">Descargar PDF</button>
</div>

<div class="panel">

<div class="flex">
<div>
<label>N° Cotización</label>
<input id="numero" readonly>
</div>
<div>
<label>Fecha emisión</label>
<input id="fecha">
</div>
<div>
<label>Válida hasta</label>
<input id="validez">
</div>
</div>

<h3>Cliente</h3>
<input id="cliente" placeholder="Nombre">
<input id="doc" placeholder="DNI / RUC">
<input id="telefono" placeholder="Teléfono">
<textarea id="direccion" placeholder="Dirección"></textarea>

<h3>Items</h3>
<input id="descripcion" placeholder="Descripción">
<input id="cantidad" type="number" value="1">
<input id="precio" type="number" value="0">
<button onclick="agregar()">Agregar</button>

<table>
<thead>
<tr>
<th>#</th>
<th>Descripción</th>
<th>Cant</th>
<th>P.Unit</th>
<th>Subtotal</th>
</tr>
</thead>
<tbody id="items"></tbody>
</table>

<div class="total-box">
Subtotal: S/ <span id="sub">0.00</span><br>
IGV 18%: S/ <span id="igv">0.00</span><br>
TOTAL: S/ <span id="tot">0.00</span>
</div>

</div>

<iframe id="preview"></iframe>
<div id="pdfContent" style="display:none;"></div>

<script>
let lista=[];

// NUMERACIÓN AUTOMÁTICA POR AÑO
function generarNumero(){
let data=JSON.parse(localStorage.getItem("cotizaciones"))||[];
let año=new Date().getFullYear();
let numeros=data.filter(c=>c.numero.startsWith(año))
.map(c=>parseInt(c.numero.split("-")[1]));
let siguiente=1;
while(numeros.includes(siguiente)) siguiente++;
numero.value=`${año}-${String(siguiente).padStart(4,"0")}`;
}

// NUEVA
function nueva(){
lista=[];
render();
generarNumero();
let hoy=new Date();
fecha.value=hoy.toLocaleDateString();
let val=new Date();
val.setDate(val.getDate()+7);
validez.value=val.toLocaleDateString();
vista();
}

// AGREGAR
function agregar(){
let d=descripcion.value;
let c=parseFloat(cantidad.value);
let p=parseFloat(precio.value);
if(!d)return;
lista.push({d,c,p});
render();
vista();
}

// RENDER
function render(){
let html="";
let sub=0;
lista.forEach((i,idx)=>{
let st=i.c*i.p;
sub+=st;
html+=`<tr>
<td>${idx+1}</td>
<td style="text-align:justify;">${i.d}</td>
<td>${i.c}</td>
<td>${i.p.toFixed(2)}</td>
<td>${st.toFixed(2)}</td>
</tr>`;
});
items.innerHTML=html;
let igv=sub*0.18;
let total=sub+igv;
sub=sub||0;
document.getElementById("sub").innerText=sub.toFixed(2);
document.getElementById("igv").innerText=igv.toFixed(2);
document.getElementById("tot").innerText=total.toFixed(2);
}

// GUARDAR
function guardar(){
let data=JSON.parse(localStorage.getItem("cotizaciones"))||[];
data.push({
numero:numero.value,
cliente:cliente.value,
doc:doc.value,
total:tot.innerText
});
localStorage.setItem("cotizaciones",JSON.stringify(data));
alert("Guardado correctamente");
}

// VISTA PDF
async function vista(){
const cot={
numero:numero.value,
cliente:cliente.value||"",
doc:doc.value||"",
telefono:telefono.value||"",
direccion:direccion.value||"",
fecha:fecha.value,
validez:validez.value,
items:lista
};
pdfContent.innerHTML=crearPDF(cot);
pdfContent.style.display="block";
await new Promise(r=>setTimeout(r,200));
const canvas=await html2canvas(pdfContent,{scale:2});
const imgData=canvas.toDataURL("image/png");
const docPDF=new jspdf.jsPDF("p","pt","a4");
const width=docPDF.internal.pageSize.getWidth();
const height=(canvas.height*width)/canvas.width;
docPDF.addImage(imgData,"PNG",0,0,width,height);
preview.src=docPDF.output("bloburl");
pdfContent.style.display="none";
}

// DESCARGAR
async function descargarPDF(){
await vista();
const canvas=await html2canvas(pdfContent,{scale:3});
const imgData=canvas.toDataURL("image/png");
const docPDF=new jspdf.jsPDF("p","pt","a4");
const width=docPDF.internal.pageSize.getWidth();
const height=(canvas.height*width)/canvas.width;
docPDF.addImage(imgData,"PNG",0,0,width,height);
docPDF.save(`Cotizacion_${numero.value}.pdf`);
}

// DISEÑO PDF
function crearPDF(cot){
let filas="";
let sub=0;
cot.items.forEach((i,idx)=>{
let st=i.c*i.p;
sub+=st;
filas+=`<tr>
<td>${idx+1}</td>
<td style="text-align:justify;">${i.d}</td>
<td>${i.c}</td>
<td>${i.p.toFixed(2)}</td>
<td>${st.toFixed(2)}</td>
</tr>`;
});
let igv=sub*0.18;
let total=sub+igv;

return `
<div>
<div style="text-align:center;">
<h2 style="margin:0;font-weight:bold;">VIDRIOS Y ALUMINIOS YURI</h2>
</div>

<div style="margin-top:15px;padding:15px;border-radius:12px;
box-shadow:0 4px 15px rgba(0,0,0,0.08);">

<b>Cotización N°:</b> ${cot.numero}<br>
<b>Fecha emisión:</b> ${cot.fecha}<br>
<b>Válida hasta:</b> ${cot.validez}<br><br>

<b>Cliente:</b> ${cot.cliente}<br>
<b>DNI/RUC:</b> ${cot.doc}<br>
<b>Teléfono:</b> ${cot.telefono}<br>
<b>Dirección:</b> ${cot.direccion}

</div>

<table border="1" width="100%" style="margin-top:20px;border-collapse:collapse;">
<tr style="background:#0059b3;color:white;">
<th>#</th>
<th>Descripción</th>
<th>Cant</th>
<th>P.Unit</th>
<th>Subtotal</th>
</tr>
${filas}
</table>

<div style="text-align:right;margin-top:15px;">
Costo: S/ ${sub.toFixed(2)}<br>
IGV (18%): S/ ${igv.toFixed(2)}<br>
<b style="font-size:16px;">TOTAL: S/ ${total.toFixed(2)}</b>
</div>

<br><br>
<div style="background:#0059b3;color:white;padding:15px;text-align:center;margin-top:40px;">
CC.HACCA S/N OMACHA - PARURO - CUSCO<br>
Correo: hermozayurihermozapuelles@gmail.com | Cel: 993 963 381
</div>

</div>
`;
}

nueva();
</script>

</body>
</html>
